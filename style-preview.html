<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dungeon Terminal</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --white:#fff;--black:#000;--yellow:#ffff00;--orange:#ff9933;
    --red:#ff0000;--gray:#666;--dim:#333;
    --font:'DotGothic16','Courier New',monospace;
  }
  html,body{height:100%;background:var(--black);color:var(--white);font-family:var(--font);overflow:hidden}
  body{display:flex;flex-direction:column}

  /* ÈÅäÊà≤Â†¥ÊôØ */
  .scene{
    flex:1; min-height:0;
    display:flex;align-items:center;justify-content:center;
    background:#000;
    border-bottom:3px solid var(--white);
  }
  .scene canvas{image-rendering:pixelated;image-rendering:crisp-edges}

  /* Â∞çË©±ÂçÄÂüü */
  .chat{
    height:40%;min-height:180px;max-height:45%;
    display:flex;flex-direction:column;
  }

  /* ÁãÄÊÖãÂàó */
  .hud{
    display:flex;gap:20px;padding:6px 16px;
    border-bottom:1px solid var(--dim);
    font-size:12px;flex-shrink:0;
  }
  .hud .m{display:flex;align-items:center;gap:6px}
  .hud .name{color:var(--yellow)}
  .hud .lv{color:var(--gray);font-size:10px}
  .hud .bar{width:60px;height:8px;background:var(--red)}
  .hud .fill{height:100%;background:var(--yellow)}
  .hud .num{color:var(--gray);font-size:10px;min-width:40px;text-align:right}

  /* Â∞çË©±Ë®òÈåÑ */
  .log{
    flex:1;overflow-y:auto;padding:12px 16px;
    scroll-behavior:smooth;
  }
  .log p{
    font-size:14px;line-height:1.75;letter-spacing:.3px;
    margin-bottom:2px;
  }
  .log .gm{color:var(--white)}
  .log .gm::before{content:'> ';color:var(--gray)}
  .log .nfa{color:#88ccff}
  .log .nfa .name{color:var(--orange);font-weight:normal}
  .log .player{color:var(--yellow)}
  .log .player::before{content:'> ';color:var(--yellow)}
  .log .sys{color:var(--gray);font-size:12px;font-style:italic}
  .log .roll{color:#88ff88}
  .log .roll::before{content:'üé≤ '}
  .log .dmg{color:var(--red)}

  /* Ëº∏ÂÖ• */
  .input-row{
    display:flex;align-items:center;gap:8px;
    padding:8px 16px;border-top:1px solid var(--dim);
    flex-shrink:0;
  }
  .input-row .prompt{color:var(--yellow);font-size:14px}
  .input-row input{
    flex:1;background:transparent;border:none;outline:none;
    font-family:var(--font);font-size:14px;
    color:var(--white);letter-spacing:.5px;
  }
  .input-row input::placeholder{color:var(--dim)}

  ::-webkit-scrollbar{width:4px}
  ::-webkit-scrollbar-track{background:var(--black)}
  ::-webkit-scrollbar-thumb{background:var(--dim)}
</style>
</head>
<body>

<!-- ÈÅäÊà≤Â†¥ÊôØ -->
<div class="scene"><canvas id="c"></canvas></div>

<!-- Â∞çË©±ÂçÄÂüü -->
<div class="chat">
  <!-- Á∞°Êòì HUD -->
  <div class="hud">
    <div class="m"><span class="name">KAEL</span><span class="lv">LV7</span><div class="bar"><div class="fill" style="width:71%"></div></div><span class="num">68/95</span></div>
    <div class="m"><span class="name">LYRA</span><span class="lv">LV6</span><div class="bar"><div class="fill" style="width:65%"></div></div><span class="num">34/52</span></div>
    <div class="m"><span class="name">VOSS</span><span class="lv">LV5</span><div class="bar"><div class="fill" style="width:92%"></div></div><span class="num">110/120</span></div>
  </div>

  <!-- Â∞çË©±Á¥ÄÈåÑ -->
  <div class="log" id="log">
    <p class="sys">‚Äî Entering Shadowmere Depths, Floor 3 ‚Äî</p>
    <p class="gm">The passage opens into a vast underground chamber. Ancient pillars line the way forward, carved with runes that pulse with faint light.</p>
    <p class="gm">The air is thick with damp stone and something else... something alive.</p>
    <p class="nfa"><span class="name">KAEL:</span> "I don't like this. Too quiet for a dungeon this deep."</p>
    <p class="nfa"><span class="name">LYRA:</span> "Those runes are warding glyphs. Something was sealed here. Be careful."</p>
    <p class="gm">You notice a faint glow coming from two treasure chests near the walls. A staircase descends further into darkness. To the south, water pools around a pair of heavy doors.</p>
    <p class="nfa"><span class="name">VOSS:</span> "I'll take point. Just say the word."</p>
    <p class="gm">What do you do?</p>
  </div>

  <!-- Ëº∏ÂÖ• -->
  <div class="input-row">
    <span class="prompt">&gt;</span>
    <input type="text" placeholder="What do you do?" autofocus id="cmd">
  </div>
</div>

<script>
// ============================================================
// RPG Maker È¢®Ê†ºÂÉèÁ¥†Â†¥ÊôØ (Canvas)
// ============================================================
const cv=document.getElementById('c'),cx=cv.getContext('2d');
const T=16,MW=20,MH=15;
cv.width=MW*T; cv.height=MH*T;
cx.imageSmoothingEnabled=false;

function fit(){
  const vp=cv.parentElement;
  const s=Math.min(vp.clientWidth/cv.width,vp.clientHeight/cv.height);
  cv.style.width=Math.floor(cv.width*s)+'px';
  cv.style.height=Math.floor(cv.height*s)+'px';
}
fit(); window.addEventListener('resize',fit);

const C={
  s1:'#585868',s2:'#4c4c5c',sH:'#6e6e82',sS:'#404050',
  w1:'#3a3248',w2:'#2e2640',wT:'#4e4660',wE:'#201830',
  cp1:'#882030',cp2:'#6c1828',cpE:'#a83848',
  dr1:'#7a5828',dr2:'#5c4018',drK:'#c8a848',
  wa1:'#2848a0',wa2:'#3058b8',
  ch1:'#a07828',ch2:'#785818',chL:'#d8c048',
  fl1:'#ff8820',fl2:'#ffcc44',
  pl1:'#7878a0',pl2:'#9090b0',plS:'#585878',
  sk:'#f0c090',skM:'#d8a070',hair:'#3838a0',
  armB:'#2850a8',armL:'#5080d8',cape:'#a82030',capeD:'#781828',boot:'#3a2820',
  slG:'#38b048',slD:'#288838',slL:'#58d868',
  bone:'#e0d8c8',boneD:'#a09888',
};
function r(x,y,w,h,c){cx.fillStyle=c;cx.fillRect(x,y,w,h)}

// Tiles
function stone(x,y){
  const p=x*T,q=y*T;
  r(p,q,T,T,(x+y)%2?C.s1:C.s2);
  r(p,q,T,1,C.sH);r(p,q,1,T,C.sH);
  r(p,q+T-1,T,1,C.sS);r(p+T-1,q,1,T,C.sS);
  if((x*7+y*3)%5===0){r(p+4,q+6,3,1,C.sS);r(p+6,q+7,1,2,C.sS)}
  if((x*3+y*11)%7===0) r(p+9,q+3,2,1,C.sS);
}
function wall(x,y){
  const p=x*T,q=y*T;
  r(p,q,T,T,C.w1);
  for(let i=0;i<3;i++){const b=q+i*5;r(p,b+4,T,1,C.wE);
    if(i%2===0)r(p+8,b,1,5,C.wE);else{r(p+4,b,1,5,C.wE);r(p+12,b,1,5,C.wE)}}
  r(p,q,T,2,C.wT);r(p,q+T-2,T,2,C.wE);
}
function wallTop(x,y){const p=x*T,q=y*T;r(p,q,T,T,C.w2);r(p,q,T,3,C.wT);r(p,q+T-1,T,1,C.wE);r(p+3,q+5,4,3,C.w1);r(p+9,q+7,5,3,C.w1)}
function carpet(x,y){const p=x*T,q=y*T;r(p,q,T,T,C.cp1);r(p,q,T,1,C.cpE);r(p,q+T-1,T,1,C.cpE);if((x+y)%2===0)r(p+4,q+4,8,8,C.cp2);r(p+7,q+3,2,1,C.cpE);r(p+6,q+4,4,1,C.cpE);r(p+5,q+5,6,1,C.cpE);r(p+6,q+6,4,1,C.cpE);r(p+7,q+7,2,1,C.cpE)}
function door(x,y){const p=x*T,q=y*T;r(p,q,T,T,C.dr2);r(p+2,q+1,12,14,C.dr1);r(p+4,q+3,4,4,C.dr2);r(p+9,q+3,4,4,C.dr2);r(p+4,q+9,4,4,C.dr2);r(p+9,q+9,4,4,C.dr2);r(p+11,q+7,2,2,C.drK)}
function chest(x,y){stone(x,y);const p=x*T,q=y*T;r(p+2,q+5,12,8,C.ch2);r(p+2,q+3,12,4,C.ch1);r(p+3,q+4,10,1,'#b88838');r(p+7,q+6,2,3,C.chL);r(p+2,q+5,12,1,'#483010')}
function pillar(x,y){stone(x,y);const p=x*T,q=y*T;r(p+4,q+2,8,12,C.pl1);r(p+5,q+2,3,12,C.pl2);r(p+10,q+2,2,12,C.plS);r(p+3,q+1,10,2,C.pl2);r(p+3,q+13,10,2,C.pl2)}
function stairs(x,y){const p=x*T,q=y*T;r(p,q,T,T,C.s2);for(let i=0;i<4;i++){const s=60-i*12;r(p+1,q+1+i*4,T-2,3,`rgb(${s},${s},${s+10})`);r(p+1,q+1+i*4,T-2,1,C.sH)}}
function water(x,y,t){const p=x*T,q=y*T,o=Math.floor(t/400)%4;r(p,q,T,T,C.wa1);for(let i=0;i<3;i++){const w=q+3+i*5+((o+i)%2);r(p+1+((i+o)%3)*2,w,5,1,C.wa2);r(p+9+((i+o)%2),w,4,1,C.wa2)}}
function torch(x,y,t){wall(x,y);const p=x*T,q=y*T;r(p+7,q+6,2,5,'#666');r(p+5,q+5,6,2,'#666');const f=4+Math.floor(Math.sin(t/150+x*3)*1.5);r(p+6,q+1+(4-f),4,f,C.fl1);r(p+7,q+2+(4-f),2,Math.max(1,f-2),C.fl2)}
function dark(x,y){r(x*T,y*T,T,T,'#08080e')}
function stone2(x,y){const p=x*T,q=y*T;r(p,q,T,T,'#686880');r(p,q,T,1,C.sH);r(p,q,1,T,C.sH);r(p,q+T-1,T,1,C.sS);r(p+T-1,q,1,T,C.sS);r(p+3,q+7,10,2,C.s1);r(p+7,q+3,2,10,C.s1)}

// Sprites
function player(px,py,t){
  const b=Math.floor(t/500)%2?-1:0;
  r(px+2,py+14,12,3,'rgba(0,0,0,.35)');
  r(px+4,py+13+b,3,2,C.boot);r(px+9,py+13+b,3,2,C.boot);
  r(px+2,py+5+b,12,8,C.capeD);r(px+3,py+5+b,10,7,C.cape);
  r(px+4,py+5+b,8,7,C.armB);r(px+5,py+6+b,2,3,C.armL);r(px+9,py+6+b,2,3,C.armL);
  r(px+4,py+10+b,8,1,C.ch2);r(px+7,py+10+b,2,1,C.chL);
  r(px+2,py+6+b,2,5,C.armB);r(px+12,py+6+b,2,5,C.armB);
  r(px+2,py+11+b,2,1,C.sk);r(px+12,py+11+b,2,1,C.sk);
  r(px+4,py+1+b,8,5,C.sk);r(px+4,py+4+b,8,2,C.skM);
  r(px+3,py+b,10,3,C.hair);r(px+3,py+1+b,2,3,C.hair);r(px+11,py+1+b,2,3,C.hair);
  r(px+5,py+3+b,2,2,'#fff');r(px+9,py+3+b,2,2,'#fff');
  r(px+6,py+3+b,1,2,'#111');r(px+10,py+3+b,1,2,'#111');
}
function slime(px,py,t){
  const s=Math.sin(t/300),h=8+Math.floor(s),w=10-Math.floor(s),o=(16-w)/2;
  r(px+3,py+13,10,2,'rgba(0,0,0,.35)');
  r(px+o,py+14-h,w,h,C.slG);r(px+o+1,py+13-h,w-2,2,C.slG);
  r(px+o+1,py+14-h,3,2,C.slL);r(px+o,py+12,w,2,C.slD);
  r(px+5,py+8,2,2,'#fff');r(px+9,py+8,2,2,'#fff');
  r(px+5,py+9,2,1,'#111');r(px+9,py+9,2,1,'#111');
}
function skeleton(px,py,t){
  const b=Math.floor(Math.sin(t/600));
  r(px+3,py+14,10,2,'rgba(0,0,0,.35)');
  r(px+5,py+11+b,2,4,C.bone);r(px+9,py+11+b,2,4,C.bone);
  r(px+4,py+5+b,8,6,C.bone);r(px+5,py+6+b,2,1,C.boneD);r(px+9,py+6+b,2,1,C.boneD);
  r(px+6,py+9+b,4,2,'#000');
  r(px+2,py+6+b,2,5,C.bone);r(px+12,py+6+b,2,5,C.bone);
  r(px+4,py+b,8,6,C.bone);r(px+5,py-1+b,6,1,C.bone);
  r(px+5,py+2+b,2,2,'#000');r(px+9,py+2+b,2,2,'#000');
  r(px+5,py+2+b,1,1,'#f33');r(px+10,py+2+b,1,1,'#f33');
  r(px+5,py+5+b,1,1,'#000');r(px+7,py+5+b,1,1,'#000');r(px+9,py+5+b,1,1,'#000');
}

// Map
const MAP=[
  'wwTwwwwwwwwwwwwwwTww','WWWWWWWWWWWWWWWWWWWW',
  'w.ssSssspSsSsssSs.w','w.sscccccccccccss.w',
  'w.sscccccccccccss.w','w.ssSSSSSSSSSSSss.w',
  'w.ssssssssssssssss.w','wTsp..sssssss..psTw',
  'w.ss..sssssss..ss.w','w.ssssssssssssssss.w',
  'w.sxsssssvssssxss.w','w.ssssss~~ssssssss.w',
  'wTsssssd~~dssssssTw','wwwwwwwwwwwwwwwwwwww',
  'wwwwwwwwwwwwwwwwwwww',
];
const TF={w:wall,W:wallTop,s:stone,S:stone2,c:carpet,d:door,p:pillar,x:chest,v:stairs,'~':water,T:torch,'.':dark};
function tile(x,y){return(MAP[y]||'')[x]||'w'}

function lighting(){
  const g=cx.createRadialGradient(cv.width/2,cv.height/2,50,cv.width/2,cv.height/2,180);
  g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(.7,'rgba(0,0,0,.15)');g.addColorStop(1,'rgba(0,0,0,.4)');
  cx.fillStyle=g;cx.fillRect(0,0,cv.width,cv.height);
  [{x:2,y:0},{x:17,y:0},{x:1,y:7},{x:18,y:7},{x:1,y:12},{x:18,y:12}].forEach(({x,y})=>{
    const a=(x+.5)*T,b=(y+.5)*T,gl=cx.createRadialGradient(a,b,0,a,b,T*3);
    gl.addColorStop(0,'rgba(255,160,40,.10)');gl.addColorStop(1,'rgba(0,0,0,0)');
    cx.fillStyle=gl;cx.fillRect(a-T*3,b-T*3,T*6,T*6);
  });
}

function render(t){
  for(let y=0;y<MH;y++)for(let x=0;x<MW;x++){const fn=TF[tile(x,y)];if(fn)fn(x,y,t);else dark(x,y)}
  [{d:skeleton,y:4,px:5*T,py:4*T-2},{d:slime,y:6,px:14*T,py:6*T-2},
   {d:player,y:8,px:9*T,py:8*T-2},{d:slime,y:9,px:16*T,py:9*T-2}]
    .sort((a,b)=>a.y-b.y).forEach(e=>e.d(e.px,e.py,t));
  lighting();
  requestAnimationFrame(render);
}
requestAnimationFrame(render);

// ============================================================
// Ê®°Êì¨ AI Â∞çË©±‰∫íÂãï
// ============================================================
const log=document.getElementById('log');
const responses=[
  {type:'gm',text:'You approach the chest cautiously. The ancient lock crumbles at your touch...'},
  {type:'roll',text:'Perception Check ‚Äî Roll: 17 + 3 = 20 (Success!)'},
  {type:'gm',text:'Inside you find a gleaming short sword, its blade etched with elvish script.'},
  {type:'nfa',name:'LYRA',text:'"Fascinating! That\'s a Moonblade. Quite rare in these parts."'},
  {type:'nfa',name:'KAEL',text:'"Less talking, more looting. What else is in there?"'},
  {type:'gm',text:'A low growl echoes from the southern passage. Something heard you.'},
  {type:'nfa',name:'VOSS',text:'"Formation. Now."'},
  {type:'dmg',text:'A Bone Stalker emerges from the darkness!'},
];
let ri=0;

function addLine(type,text,name){
  const p=document.createElement('p');
  p.className=type;
  if(type==='nfa') p.innerHTML='<span class="name">'+name+':</span> '+text;
  else p.textContent=text;
  log.appendChild(p);
  log.scrollTop=log.scrollHeight;
}

document.getElementById('cmd').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&e.target.value.trim()){
    addLine('player',e.target.value);
    e.target.value='';
    // Ê®°Êì¨ AI ÂõûÊáâÔºà‰æùÂ∫èÊí≠ÊîæÔºâ
    const delay=[500,1200,2000,2800];
    for(let i=0;i<Math.min(3,responses.length-ri);i++){
      const resp=responses[ri+i];
      setTimeout(()=>addLine(resp.type,resp.text,resp.name),delay[i]);
    }
    ri=(ri+3)%responses.length;
  }
});
</script>
</body>
</html>
